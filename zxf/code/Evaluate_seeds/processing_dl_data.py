import pickle
import fire
import numpy as np
import pandas as pd
from scipy.stats import rankdata
from sklearn.cluster import AgglomerativeClustering
from multiprocessing import Pool, cpu_count
from functools import partial
from tqdm import tqdm
from pathlib import Path

from pandas import IndexSlice as idx

# 数据读取
def read_pkl(data_dir):
    with open(data_dir, "rb") as f:
        dl = pickle.load(f)
    return dl

def filter_column(dl_data_path,save_path, need_cols):
    
    dl_data = read_pkl(dl_data_path)
    df = dl_data.data

    # 筛选列
    feature_names = df['feature'].columns
    feature_df = df.loc[:, ('feature', need_cols)]
    
    label_df = df.loc[:, 'label']
    label_df.columns = pd.MultiIndex.from_product(
        [['label'], label_df.columns]
    )
    
    df_filtered = pd.concat([feature_df, label_df], axis=1)
    df_filtered = df_filtered.loc[:, df.columns.intersection(df_filtered.columns)]
    dl_data.data = df_filtered

    # 保存
    with open(save_path, 'wb') as file: pickle.dump(dl_data, file)
            
    return dl_data

def main(
    data_dir: str = "/home/idc2/notebook/quant/data/experimental_results/csi800_512_20260119_20150101_20260116",
    market_name: str = 'csi800',
):
    ### 定义目录
    # data_dir = "/home/a/notebook/zxf/data/Daily_data/Training_data/csi800"
    # data_path = f"{data_dir}/{market_name}"
    data_path = f"{data_dir}"

    # 门控
    # gate_cols = [
    #     # '$adjusted_fully_diluted_earnings_per_share_ttm',
    #     # '$adjusted_return_on_equity_ttm',
    #     # '$return_on_asset_net_profit_ttm',
    #     # '$net_profit_margin_ttm',
    #     # '$net_profit_to_revenue_ttm',
    #     # '$total_asset_turnover_ttm',
    #     # '$operating_cash_flow_per_share_ttm',
    #     # '$ocf_to_debt_ttm',
    #     # '$debt_to_asset_ratio_ttm',
    #     # '$debt_to_equity_ratio_ttm',
    #     # '$book_value_per_share_ttm',
    #     # '$inc_revenue_ttm',
    #     # '$inc_book_per_share_ttm',
    #     # '$net_profit_growth_ratio_ttm',
    #     '$i_change_1',
    #     '$i_change_1_mean_5',
    #     '$i_change_1_std_5',
    #     # '$i_change_1_mean_10',
    #     # '$i_change_1_std_10',
    #     '$i_change_1_mean_20',
    #     '$i_change_1_std_20',
    #     # '$i_change_1_mean_30',
    #     # '$i_change_1_std_30',
    #     # '$i_change_1_mean_60',
    #     # '$i_change_1_std_60',
        
    #     'Mask($close/Ref($close,1)-1, "sh000001")',
    #     'Mask(Mean($close/Ref($close,1)-1,5), "sh000001")',
    #     'Mask(Std($close/Ref($close,1)-1,5), "sh000001")',
    #     'Mask(Mean($volume,5)/$volume, "sh000001")',
    #     'Mask(Std($volume,5)/$volume, "sh000001")',
    #     # 'Mask(Mean($close/Ref($close,1)-1,10), "sh000001")',
    #     # 'Mask(Std($close/Ref($close,1)-1,10), "sh000001")',
    #     # 'Mask(Mean($volume,10)/$volume, "sh000001")',
    #     # 'Mask(Std($volume,10)/$volume, "sh000001")',
    #     'Mask(Mean($close/Ref($close,1)-1,20), "sh000001")',
    #     'Mask(Std($close/Ref($close,1)-1,20), "sh000001")',
    #     'Mask(Mean($volume,20)/$volume, "sh000001")',
    #     'Mask(Std($volume,20)/$volume, "sh000001")',
    #     # 'Mask(Mean($close/Ref($close,1)-1,30), "sh000001")',
    #     # 'Mask(Std($close/Ref($close,1)-1,30), "sh000001")',
    #     # 'Mask(Mean($volume,30)/$volume, "sh000001")',
    #     # 'Mask(Std($volume,30)/$volume, "sh000001")',
    #     # 'Mask(Mean($close/Ref($close,1)-1,60), "sh000001")',
    #     # 'Mask(Std($close/Ref($close,1)-1,60), "sh000001")',
    #     # 'Mask(Mean($volume,60)/$volume, "sh000001")',
    #     # 'Mask(Std($volume,60)/$volume, "sh000001")',
        
    #     'Mask($close/Ref($close,1)-1, "sh000300")',
    #     'Mask(Mean($close/Ref($close,1)-1,5), "sh000300")',
    #     'Mask(Std($close/Ref($close,1)-1,5), "sh000300")',
    #     'Mask(Mean($volume,5)/$volume, "sh000300")',
    #     'Mask(Std($volume,5)/$volume, "sh000300")',
    #     # 'Mask(Mean($close/Ref($close,1)-1,10), "sh000300")',
    #     # 'Mask(Std($close/Ref($close,1)-1,10), "sh000300")',
    #     # 'Mask(Mean($volume,10)/$volume, "sh000300")',
    #     # 'Mask(Std($volume,10)/$volume, "sh000300")',
    #     'Mask(Mean($close/Ref($close,1)-1,20), "sh000300")',
    #     'Mask(Std($close/Ref($close,1)-1,20), "sh000300")',
    #     'Mask(Mean($volume,20)/$volume, "sh000300")',
    #     'Mask(Std($volume,20)/$volume, "sh000300")',
    #     # 'Mask(Mean($close/Ref($close,1)-1,30), "sh000300")',
    #     # 'Mask(Std($close/Ref($close,1)-1,30), "sh000300")',
    #     # 'Mask(Mean($volume,30)/$volume, "sh000300")',
    #     # 'Mask(Std($volume,30)/$volume, "sh000300")',
    #     # 'Mask(Mean($close/Ref($close,1)-1,60), "sh000300")',
    #     # 'Mask(Std($close/Ref($close,1)-1,60), "sh000300")',
    #     # 'Mask(Mean($volume,60)/$volume, "sh000300")',
    #     # 'Mask(Std($volume,60)/$volume, "sh000300")',
        
    #     'Mask($close/Ref($close,1)-1, "sh000905")',
    #     'Mask(Mean($close/Ref($close,1)-1,5), "sh000905")',
    #     'Mask(Std($close/Ref($close,1)-1,5), "sh000905")',
    #     'Mask(Mean($volume,5)/$volume, "sh000905")',
    #     'Mask(Std($volume,5)/$volume, "sh000905")',
    #     # 'Mask(Mean($close/Ref($close,1)-1,10), "sh000905")',
    #     # 'Mask(Std($close/Ref($close,1)-1,10), "sh000905")',
    #     # 'Mask(Mean($volume,10)/$volume, "sh000905")',
    #     # 'Mask(Std($volume,10)/$volume, "sh000905")',
    #     'Mask(Mean($close/Ref($close,1)-1,20), "sh000905")',
    #     'Mask(Std($close/Ref($close,1)-1,20), "sh000905")',
    #     'Mask(Mean($volume,20)/$volume, "sh000905")',
    #     'Mask(Std($volume,20)/$volume, "sh000905")',
    #     # 'Mask(Mean($close/Ref($close,1)-1,30), "sh000905")',
    #     # 'Mask(Std($close/Ref($close,1)-1,30), "sh000905")',
    #     # 'Mask(Mean($volume,30)/$volume, "sh000905")',
    #     # 'Mask(Std($volume,30)/$volume, "sh000905")',
    #     # 'Mask(Mean($close/Ref($close,1)-1,60), "sh000905")',
    #     # 'Mask(Std($close/Ref($close,1)-1,60), "sh000905")',
    #     # 'Mask(Mean($volume,60)/$volume, "sh000905")',
    #     # 'Mask(Std($volume,60)/$volume, "sh000905")',
        
    #     'Mask($close/Ref($close,1)-1, "sh000906")',
    #     'Mask(Mean($close/Ref($close,1)-1,5), "sh000906")',
    #     'Mask(Std($close/Ref($close,1)-1,5), "sh000906")',
    #     'Mask(Mean($volume,5)/$volume, "sh000906")',
    #     'Mask(Std($volume,5)/$volume, "sh000906")',
    #     # 'Mask(Mean($close/Ref($close,1)-1,10), "sh000906")',
    #     # 'Mask(Std($close/Ref($close,1)-1,10), "sh000906")',
    #     # 'Mask(Mean($volume,10)/$volume, "sh000906")',
    #     # 'Mask(Std($volume,10)/$volume, "sh000906")',
    #     'Mask(Mean($close/Ref($close,1)-1,20), "sh000906")',
    #     'Mask(Std($close/Ref($close,1)-1,20), "sh000906")',
    #     'Mask(Mean($volume,20)/$volume, "sh000906")',
    #     'Mask(Std($volume,20)/$volume, "sh000906")',
    #     # 'Mask(Mean($close/Ref($close,1)-1,30), "sh000906")',
    #     # 'Mask(Std($close/Ref($close,1)-1,30), "sh000906")',
    #     # 'Mask(Mean($volume,30)/$volume, "sh000906")',
    #     # 'Mask(Std($volume,30)/$volume, "sh000906")',
    #     # 'Mask(Mean($close/Ref($close,1)-1,60), "sh000906")',
    #     # 'Mask(Std($close/Ref($close,1)-1,60), "sh000906")',
    #     # 'Mask(Mean($volume,60)/$volume, "sh000906")',
    #     # 'Mask(Std($volume,60)/$volume, "sh000906")'
    # ]

    
    # ### 读取需要的列名
    # # notebook/zxf/data/Daily_data/Good_seed/seed7/factor_analysis_report_20260107_174156.csv
    
    # filter_cols_path = f"{data_path}/factor_analysis_report_20260107_174156.csv"
    # filter_cols_file = pd.read_csv(filter_cols_path)

    # # 筛选条件
    # df = filter_cols_file.copy()
    # con = df['final_advice'] == "KEEP_CORE"
    # df_s = df[con]

    # filte_cols = df_s['factor'].tolist()
    # need_cols = filte_cols + gate_cols
    # need_cols = list(dict.fromkeys(need_cols))

    need_cols = [
        "$adjusted_fully_diluted_earnings_per_share_ttm",
        "$adjusted_return_on_equity_ttm",
        "$d_close_rank",
        "$d_close_vwap",
        "$d_close_vwap/($close+1e-12)",
        "$d_cntp",
        "$d_hhi",
        "$d_high_time_frac",
        "$d_intraday_trend",
        "$d_pm_vwap/($close+1e-12)",
        "$d_realized_vol",
        "$d_ret_skew",
        "$d_trades_close_corr",
        "$d_trades_vol_corr",
        "$d_vol",
        "$d_vol_cv",
        "$d_volatility_of_volume",
        "$debt_to_asset_ratio_ttm",
        "$debt_to_equity_ratio_ttm",
        "$high/($close+1e-12)",
        "$i_change_1",
        "$i_change_1_mean_10",
        "$i_change_1_mean_20",
        "$i_change_1_mean_30",
        "$i_change_1_mean_5",
        "$i_change_1_std_30",
        "$i_change_1_std_5",
        "$i_change_1_std_60",
        "$inc_book_per_share_ttm",
        "$inc_revenue_ttm",
        "$low/($close+1e-12)",
        "$net_profit_growth_ratio_ttm",
        "$net_profit_margin_ttm",
        "$net_profit_to_revenue_ttm",
        "$ocf_to_debt_ttm",
        "$open/($close+1e-12)",
        "$pb_ratio_ttm",
        "$peg_ratio_ttm",
        "$ps_ratio_ttm",
        "$return_on_asset_net_profit_ttm",
        "$total_asset_turnover_ttm",
        "$turn/($turn_current_year+1e-12)",
        "$turn/($turn_year+1e-12)",
        "$turn_week/($turn_current_year+1e-12)",
        "$turn_week/($turn_year+1e-12)",
        "$volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12))",
        "($close-$open)/$open",
        "($high-$low)/$open",
        "($high-Greater($open, $close))/$open",
        "($high-Greater($open, $close))/($high-$low+1e-12)",
        "(2*$close-$high-$low)/$open",
        "(Less($open, $close)-$low)/$open",
        "(Less($open, $close)-$low)/($high-$low+1e-12)",
        "Corr($close, Log($D_CORR + 1), 23)",
        "Corr($close, Log($D_CORR + 1), 61)",
        "Corr($close, Log($D_DWR + 1), 23)",
        "Corr($close, Log($D_DWR + 1), 61)",
        "Corr($close, Log($D_REALIZED_VOL + 1), 11)",
        "Corr($close, Log($D_REALIZED_VOL + 1), 23)",
        "Corr($close, Log($D_REALIZED_VOL + 1), 5)",
        "Corr($close, Log($D_VOL + 1), 11)",
        "Corr($close, Log($D_VOL + 1), 23)",
        "Corr($close, Log($D_VOL + 1), 5)",
        "Corr($close, Log($D_VWAP + 1), 11)",
        "Corr($close, Log($D_VWAP + 1), 23)",
        "Corr($close, Log($D_VWAP + 1), 61)",
        "Corr($close/Ref($close,1), Log($D_CORR/Ref($D_CORR, 1)+1), 23)",
        "Corr($close/Ref($close,1), Log($D_CORR/Ref($D_CORR, 1)+1), 61)",
        "Corr($close/Ref($close,1), Log($D_DWR/Ref($D_DWR, 1)+1), 23)",
        "Corr($close/Ref($close,1), Log($D_DWR/Ref($D_DWR, 1)+1), 61)",
        "Corr($close/Ref($close,1), Log($D_REALIZED_VOL/Ref($D_REALIZED_VOL, 1)+1), 11)",
        "Corr($close/Ref($close,1), Log($D_REALIZED_VOL/Ref($D_REALIZED_VOL, 1)+1), 5)",
        "Corr($close/Ref($close,1), Log($D_TRADES_CLOSE_CORR/Ref($D_TRADES_CLOSE_CORR, 1)+1), 23)",
        "Corr($close/Ref($close,1), Log($D_TRADES_CLOSE_CORR/Ref($D_TRADES_CLOSE_CORR, 1)+1), 61)",
        "Corr($close/Ref($close,1), Log($D_TRADES_VOL_CORR/Ref($D_TRADES_VOL_CORR, 1)+1), 23)",
        "Corr($close/Ref($close,1), Log($D_TRADES_VOL_CORR/Ref($D_TRADES_VOL_CORR, 1)+1), 61)",
        "Corr($close/Ref($close,1), Log($D_VOL/Ref($D_VOL, 1)+1), 11)",
        "Corr($close/Ref($close,1), Log($D_VOL/Ref($D_VOL, 1)+1), 5)",
        "Corr($close/Ref($close,1), Log($D_VWAP/Ref($D_VWAP, 1)+1), 11)",
        "Corr($close/Ref($close,1), Log($D_VWAP/Ref($D_VWAP, 1)+1), 23)",
        "Corr($close/Ref($close,1), Log($D_VWAP/Ref($D_VWAP, 1)+1), 61)",
        "IdxMax($high, 23)/23",
        "IdxMin($low, 11)/11",
        "IdxMin($low, 23)/23",
        "Max($high, 11)/$close",
        "Max($high, 5)/$close",
        "Mean($close, 23)/($close + 1e-12)",
        "Mean($close<Ref($close, 1), 11)",
        "Mean($close<Ref($close, 1), 23)",
        "Mean($close<Ref($close, 1), 5)",
        "Mean($close>Ref($close, 1), 11)-Mean($close<Ref($close, 1), 11)",
        "Mean($close>Ref($close, 1), 23)",
        "Mean($close>Ref($close, 1), 5)",
        "Mean($d_cntn, 11)/($d_cntn + 1e-12)",
        "Mean($d_cntn, 5)/($d_cntn + 1e-12)",
        "Mean($d_cntn<Ref($d_cntn, 1), 11)",
        "Mean($d_cntn<Ref($d_cntn, 1), 5)",
        "Mean($d_cntn>Ref($d_cntn, 1), 11)",
        "Mean($d_cntn>Ref($d_cntn, 1), 11)-Mean($d_cntn<Ref($d_cntn, 1), 11)",
        "Mean($d_cntn>Ref($d_cntn, 1), 5)",
        "Mean($d_cntn>Ref($d_cntn, 1), 5)-Mean($d_cntn<Ref($d_cntn, 1), 5)",
        "Mean($d_cntp, 11)/($d_cntp + 1e-12)",
        "Mean($d_cntp, 5)/($d_cntp + 1e-12)",
        "Mean($d_cntp<Ref($d_cntp, 1), 11)",
        "Mean($d_cntp<Ref($d_cntp, 1), 5)",
        "Mean($d_cntp>Ref($d_cntp, 1), 11)",
        "Mean($d_cntp>Ref($d_cntp, 1), 11)-Mean($d_cntp<Ref($d_cntp, 1), 11)",
        "Mean($d_cntp>Ref($d_cntp, 1), 5)",
        "Mean($d_cntp>Ref($d_cntp, 1), 5)-Mean($d_cntp<Ref($d_cntp, 1), 5)",
        "Mean($d_corr, 23)/($d_corr + 1e-12)",
        "Mean($d_corr, 61)/($d_corr + 1e-12)",
        "Mean($d_dwr, 23)/($d_dwr + 1e-12)",
        "Mean($d_dwr, 61)/($d_dwr + 1e-12)",
        "Mean($d_intraday_trend, 11)/($d_intraday_trend + 1e-12)",
        "Mean($d_intraday_trend, 5)/($d_intraday_trend + 1e-12)",
        "Mean($d_low_time_frac, 11)/($d_low_time_frac + 1e-12)",
        "Mean($d_low_time_frac, 23)/($d_low_time_frac + 1e-12)",
        "Mean($d_ret_kurt, 5)/($d_ret_kurt + 1e-12)",
        "Mean($d_ret_skew, 5)/($d_ret_skew + 1e-12)",
        "Mean($d_trades_close_corr, 23)/($d_trades_close_corr + 1e-12)",
        "Mean($d_trades_close_corr, 61)/($d_trades_close_corr + 1e-12)",
        "Mean($d_trades_vol_corr, 23)/($d_trades_vol_corr + 1e-12)",
        "Mean($d_vol_skew, 61)/($d_vol_skew + 1e-12)",
        "Mean($d_volatility_of_volume, 61)/($d_volatility_of_volume + 1e-12)",
        "Mean($turn, 23)/($turn + 1e-12)",
        "Mean($turn, 5)/($turn + 1e-12)",
        "Mean($turn<Ref($turn, 1), 11)",
        "Mean($turn<Ref($turn, 1), 23)",
        "Mean($turn<Ref($turn, 1), 5)",
        "Mean($turn>Ref($turn, 1), 11)",
        "Mean($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 11)/($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)))",
        "Mean($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 61)/($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)))",
        "Mean($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12))<Ref($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 1), 11)",
        "Mean($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12))<Ref($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 1), 23)",
        "Mean($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12))>Ref($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 1), 11)",
        "Mean($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12))>Ref($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 1), 11)-Mean($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12))<Ref($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 1), 11)",
        "Mean($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12))>Ref($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 1), 23)",
        "Mean($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12))>Ref($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 1), 23)-Mean($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12))<Ref($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 1), 23)",
        "Mean($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12))>Ref($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 1), 61)",
        "Mean($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12))>Ref($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 1), 61)-Mean($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12))<Ref($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 1), 61)",
        "Mean($volume, 23)/($volume + 1e-12)",
        "Mean($volume, 5)/($volume + 1e-12)",
        "Mean($volume<Ref($volume, 1), 11)",
        "Mean($volume<Ref($volume, 1), 23)",
        "Mean($volume>Ref($volume, 1), 11)",
        "Mean($volume>Ref($volume, 1), 5)",
        "Mean(($buy_volume*2-$volume)/($volume+1e-12), 5)/(($buy_volume*2-$volume)/($volume+1e-12))",
        "Mean(($buy_volume*2-$volume)/($volume+1e-12)<Ref(($buy_volume*2-$volume)/($volume+1e-12), 1), 11)",
        "Mean(($buy_volume*2-$volume)/($volume+1e-12)<Ref(($buy_volume*2-$volume)/($volume+1e-12), 1), 23)",
        "Mean(($buy_volume*2-$volume)/($volume+1e-12)<Ref(($buy_volume*2-$volume)/($volume+1e-12), 1), 5)",
        "Mean(($buy_volume*2-$volume)/($volume+1e-12)>Ref(($buy_volume*2-$volume)/($volume+1e-12), 1), 11)-Mean(($buy_volume*2-$volume)/($volume+1e-12)<Ref(($buy_volume*2-$volume)/($volume+1e-12), 1), 11)",
        "Mean(($buy_volume*2-$volume)/($volume+1e-12)>Ref(($buy_volume*2-$volume)/($volume+1e-12), 1), 23)-Mean(($buy_volume*2-$volume)/($volume+1e-12)<Ref(($buy_volume*2-$volume)/($volume+1e-12), 1), 23)",
        "Mean(($buy_volume*2-$volume)/($volume+1e-12)>Ref(($buy_volume*2-$volume)/($volume+1e-12), 1), 5)",
        "Mean(($buy_volume*2-$volume)/($volume+1e-12)>Ref(($buy_volume*2-$volume)/($volume+1e-12), 1), 5)-Mean(($buy_volume*2-$volume)/($volume+1e-12)<Ref(($buy_volume*2-$volume)/($volume+1e-12), 1), 5)",
        "Mean((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 11)/((($buy_amount*2-$amount)*10000)/($market_cap+1e-12))",
        "Mean((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 23)/((($buy_amount*2-$amount)*10000)/($market_cap+1e-12))",
        "Mean((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 5)/((($buy_amount*2-$amount)*10000)/($market_cap+1e-12))",
        "Mean((($buy_amount*2-$amount)*10000)/($market_cap+1e-12)<Ref((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 1), 5)",
        "Mean((($buy_amount*2-$amount)*10000)/($market_cap+1e-12)>Ref((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 1), 11)",
        "Mean((($buy_amount*2-$amount)*10000)/($market_cap+1e-12)>Ref((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 1), 11)-Mean((($buy_amount*2-$amount)*10000)/($market_cap+1e-12)<Ref((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 1), 11)",
        "Mean((($buy_amount*2-$amount)*10000)/($market_cap+1e-12)>Ref((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 1), 23)",
        "Mean((($buy_amount*2-$amount)*10000)/($market_cap+1e-12)>Ref((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 1), 23)-Mean((($buy_amount*2-$amount)*10000)/($market_cap+1e-12)<Ref((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 1), 23)",
        "Mean((($buy_amount*2-$amount)*10000)/($market_cap+1e-12)>Ref((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 1), 5)",
        "Mean((($buy_amount*2-$amount)*10000)/($market_cap+1e-12)>Ref((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 1), 5)-Mean((($buy_amount*2-$amount)*10000)/($market_cap+1e-12)<Ref((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 1), 5)",
        "Min($low, 11)/$close",
        "Min($low, 5)/$close",
        "Quantile($d_close_rank, 11, 0.2)/($d_close_rank + 1e-12)",
        "Quantile($d_close_rank, 23, 0.2)/($d_close_rank + 1e-12)",
        "Quantile($d_close_vwap, 23, 0.8)/($d_close_vwap + 1e-12)",
        "Quantile($d_close_vwap, 61, 0.8)/($d_close_vwap + 1e-12)",
        "Quantile($d_corr, 23, 0.2)/($d_corr + 1e-12)",
        "Quantile($d_corr, 61, 0.2)/($d_corr + 1e-12)",
        "Quantile($d_dwr, 23, 0.2)/($d_dwr + 1e-12)",
        "Quantile($d_dwr, 23, 0.8)/($d_dwr + 1e-12)",
        "Quantile($d_hhi, 23, 0.2)/($d_hhi + 1e-12)",
        "Quantile($d_hhi, 61, 0.2)/($d_hhi + 1e-12)",
        "Quantile($d_intraday_trend, 11, 0.8)/($d_intraday_trend + 1e-12)",
        "Quantile($d_intraday_trend, 5, 0.2)/($d_intraday_trend + 1e-12)",
        "Quantile($d_intraday_trend, 5, 0.8)/($d_intraday_trend + 1e-12)",
        "Quantile($d_realized_vol, 23, 0.2)/($d_realized_vol + 1e-12)",
        "Quantile($d_realized_vol, 5, 0.8)/($d_realized_vol + 1e-12)",
        "Quantile($d_ret_kurt, 11, 0.2)/($d_ret_kurt + 1e-12)",
        "Quantile($d_ret_kurt, 5, 0.2)/($d_ret_kurt + 1e-12)",
        "Quantile($d_ret_kurt, 5, 0.8)/($d_ret_kurt + 1e-12)",
        "Quantile($d_ret_skew, 11, 0.2)/($d_ret_skew + 1e-12)",
        "Quantile($d_ret_skew, 11, 0.8)/($d_ret_skew + 1e-12)",
        "Quantile($d_ret_skew, 23, 0.2)/($d_ret_skew + 1e-12)",
        "Quantile($d_ret_skew, 5, 0.2)/($d_ret_skew + 1e-12)",
        "Quantile($d_ret_skew, 5, 0.8)/($d_ret_skew + 1e-12)",
        "Quantile($d_trades_close_corr, 23, 0.2)/($d_trades_close_corr + 1e-12)",
        "Quantile($d_trades_close_corr, 23, 0.8)/($d_trades_close_corr + 1e-12)",
        "Quantile($d_trades_close_corr, 61, 0.2)/($d_trades_close_corr + 1e-12)",
        "Quantile($d_trades_close_corr, 61, 0.8)/($d_trades_close_corr + 1e-12)",
        "Quantile($d_trades_vol_corr, 23, 0.2)/($d_trades_vol_corr + 1e-12)",
        "Quantile($d_trades_vol_corr, 23, 0.8)/($d_trades_vol_corr + 1e-12)",
        "Quantile($d_trades_vol_corr, 61, 0.2)/($d_trades_vol_corr + 1e-12)",
        "Quantile($d_trades_vol_corr, 61, 0.8)/($d_trades_vol_corr + 1e-12)",
        "Quantile($d_vol, 23, 0.2)/($d_vol + 1e-12)",
        "Quantile($d_vol, 5, 0.8)/($d_vol + 1e-12)",
        "Quantile($d_vol_kurt, 23, 0.2)/($d_vol_kurt + 1e-12)",
        "Quantile($d_vol_skew, 23, 0.2)/($d_vol_skew + 1e-12)",
        "Quantile($d_volatility_of_volume, 61, 0.2)/($d_volatility_of_volume + 1e-12)",
        "Rank($d_close_rank, 11)",
        "Rank($d_cntn, 11)",
        "Rank($d_cntn, 5)",
        "Rank($d_cntp, 11)",
        "Rank($d_cntp, 5)",
        "Rank($d_hhi, 61)",
        "Rank($d_high_time_frac, 11)",
        "Rank($d_high_time_frac, 23)",
        "Rank($d_intraday_trend, 11)",
        "Rank($d_intraday_trend, 5)",
        "Rank($d_low_time_frac, 11)",
        "Rank($d_low_time_frac, 23)",
        "Rank($d_realized_vol, 23)",
        "Rank($d_realized_vol, 5)",
        "Rank($d_ret_kurt, 11)",
        "Rank($d_ret_kurt, 23)",
        "Rank($d_ret_skew, 23)",
        "Rank($d_trades_close_corr, 61)",
        "Rank($d_trades_vol_corr, 23)",
        "Rank($d_vol, 23)",
        "Rank($d_vol, 5)",
        "Rank($d_vol_cv, 61)",
        "Rank($d_vol_kurt, 61)",
        "Rank($d_volatility_of_volume, 61)",
        "Rank(($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12))), 23)",
        "Rank(($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12))), 61)",
        "Ref($close, 23)/($close+1e-12)",
        "Ref($close, 5)/($close+1e-12)",
        "Ref($d_close_rank, 11)/($d_close_rank+1e-12)",
        "Ref($d_close_rank, 23)/($d_close_rank+1e-12)",
        "Ref($d_corr, 23)/($d_corr+1e-12)",
        "Ref($d_corr, 61)/($d_corr+1e-12)",
        "Ref($d_dwr, 23)/($d_dwr+1e-12)",
        "Ref($d_dwr, 61)/($d_dwr+1e-12)",
        "Ref($d_hhi, 23)/($d_hhi+1e-12)",
        "Ref($d_hhi, 61)/($d_hhi+1e-12)",
        "Ref($d_high_time_frac, 11)/($d_high_time_frac+1e-12)",
        "Ref($d_high_time_frac, 23)/($d_high_time_frac+1e-12)",
        "Ref($d_intraday_trend, 11)/($d_intraday_trend+1e-12)",
        "Ref($d_intraday_trend, 5)/($d_intraday_trend+1e-12)",
        "Ref($d_low_time_frac, 11)/($d_low_time_frac+1e-12)",
        "Ref($d_low_time_frac, 23)/($d_low_time_frac+1e-12)",
        "Ref($d_realized_vol, 23)/($d_realized_vol+1e-12)",
        "Ref($d_realized_vol, 5)/($d_realized_vol+1e-12)",
        "Ref($d_ret_kurt, 23)/($d_ret_kurt+1e-12)",
        "Ref($d_ret_skew, 11)/($d_ret_skew+1e-12)",
        "Ref($d_ret_skew, 23)/($d_ret_skew+1e-12)",
        "Ref($d_ret_skew, 5)/($d_ret_skew+1e-12)",
        "Ref($d_trades_close_corr, 23) - $d_trades_close_corr",
        "Ref($d_trades_close_corr, 61) - $d_trades_close_corr",
        "Ref($d_trades_vol_corr, 23) - $d_trades_vol_corr",
        "Ref($d_trades_vol_corr, 61) - $d_trades_vol_corr",
        "Ref($d_vol, 23)/($d_vol+1e-12)",
        "Ref($d_vol, 5)/($d_vol+1e-12)",
        "Ref($d_vol_cv, 23) - $d_vol_cv",
        "Ref($d_vol_cv, 61) - $d_vol_cv",
        "Ref($d_vol_kurt, 23)/($d_vol_kurt+1e-12)",
        "Ref($d_vol_kurt, 61)/($d_vol_kurt+1e-12)",
        "Ref($d_vol_skew, 23)/($d_vol_skew+1e-12)",
        "Ref($d_vol_skew, 61)/($d_vol_skew+1e-12)",
        "Ref($d_volatility_of_volume, 61)/($d_volatility_of_volume+1e-12)",
        "Ref($low, 1)/($close+1e-12)",
        "Ref($open, 3)/($close+1e-12)",
        "Ref($turn, 5)/($turn+1e-12)",
        "Ref($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 11)/($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)))",
        "Ref($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 23)/($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)))",
        "Ref($volume, 1)/($volume+1e-12)",
        "Ref($volume, 11)/($volume+1e-12)",
        "Ref($volume, 23)/($volume+1e-12)",
        "Ref($volume, 5)/($volume+1e-12)",
        "Ref($vwap, 1)/($close+1e-12)",
        "Ref(($buy_volume*2-$volume)/($volume+1e-12), 11)/(($buy_volume*2-$volume)/($volume+1e-12))",
        "Ref(($buy_volume*2-$volume)/($volume+1e-12), 23)/(($buy_volume*2-$volume)/($volume+1e-12))",
        "Ref(($buy_volume*2-$volume)/($volume+1e-12), 5)/(($buy_volume*2-$volume)/($volume+1e-12))",
        "Ref((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 11)/((($buy_amount*2-$amount)*10000)/($market_cap+1e-12))",
        "Ref((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 23)/((($buy_amount*2-$amount)*10000)/($market_cap+1e-12))",
        "Ref((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 5)/((($buy_amount*2-$amount)*10000)/($market_cap+1e-12))",
        "Resi($close, 11)/($close + 1e-12)",
        "Resi($close, 23)/($close + 1e-12)",
        "Resi($close, 5)/($close + 1e-12)",
        "Resi($turn, 23)/($turn + 1e-12)",
        "Resi($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 11)/($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)))",
        "Resi($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 23)/($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)))",
        "Resi($volume, 23)/($volume + 1e-12)",
        "Resi($volume, 5)/($volume + 1e-12)",
        "Resi(($buy_volume*2-$volume)/($volume+1e-12), 11)/(($buy_volume*2-$volume)/($volume+1e-12))",
        "Resi(($buy_volume*2-$volume)/($volume+1e-12), 5)/(($buy_volume*2-$volume)/($volume+1e-12))",
        "Resi((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 11)/((($buy_amount*2-$amount)*10000)/($market_cap+1e-12))",
        "Resi((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 23)/((($buy_amount*2-$amount)*10000)/($market_cap+1e-12))",
        "Resi((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 5)/((($buy_amount*2-$amount)*10000)/($market_cap+1e-12))",
        "Rsquare($close, 11)/($close + 1e-12)",
        "Rsquare($close, 23)/($close + 1e-12)",
        "Rsquare($close, 5)/($close + 1e-12)",
        "Rsquare($d_corr, 61)/($d_corr + 1e-12)",
        "Rsquare($d_hhi, 23)/($d_hhi + 1e-12)",
        "Rsquare($d_hhi, 61)/($d_hhi + 1e-12)",
        "Rsquare($d_intraday_trend, 11)/($d_intraday_trend + 1e-12)",
        "Rsquare($d_intraday_trend, 5)/($d_intraday_trend + 1e-12)",
        "Rsquare($d_realized_vol, 11)/($d_realized_vol + 1e-12)",
        "Rsquare($d_realized_vol, 23)/($d_realized_vol + 1e-12)",
        "Rsquare($d_realized_vol, 5)/($d_realized_vol + 1e-12)",
        "Rsquare($d_vol, 11)/($d_vol + 1e-12)",
        "Rsquare($d_vol, 23)/($d_vol + 1e-12)",
        "Rsquare($d_vol, 5)/($d_vol + 1e-12)",
        "Rsquare($turn, 11)/($turn + 1e-12)",
        "Rsquare($turn, 23)/($turn + 1e-12)",
        "Rsquare($turn, 5)/($turn + 1e-12)",
        "Rsquare($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 11)",
        "Rsquare($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 23)",
        "Rsquare($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 61)",
        "Rsquare($volume, 11)/($volume + 1e-12)",
        "Rsquare($volume, 23)/($volume + 1e-12)",
        "Rsquare($volume, 5)/($volume + 1e-12)",
        "Rsquare(($buy_volume*2-$volume)/($volume+1e-12), 11)",
        "Rsquare(($buy_volume*2-$volume)/($volume+1e-12), 23)",
        "Rsquare(($buy_volume*2-$volume)/($volume+1e-12), 5)",
        "Rsquare((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 11)",
        "Rsquare((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 23)",
        "Rsquare((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 5)",
        "Slope($d_am_vwap, 61)/($d_am_vwap + 1e-12)",
        "Slope($d_close_rank, 11)/($d_close_rank + 1e-12)",
        "Slope($d_close_rank, 23)/($d_close_rank + 1e-12)",
        "Slope($d_corr, 23)/($d_corr + 1e-12)",
        "Slope($d_corr, 61)/($d_corr + 1e-12)",
        "Slope($d_dwr, 23)/($d_dwr + 1e-12)",
        "Slope($d_dwr, 61)/($d_dwr + 1e-12)",
        "Slope($d_hhi, 23)/($d_hhi + 1e-12)",
        "Slope($d_hhi, 61)/($d_hhi + 1e-12)",
        "Slope($d_intraday_trend, 11)/($d_intraday_trend + 1e-12)",
        "Slope($d_intraday_trend, 5)/($d_intraday_trend + 1e-12)",
        "Slope($d_open_vwap, 61)/($d_open_vwap + 1e-12)",
        "Slope($d_realized_vol, 11)/($d_realized_vol + 1e-12)",
        "Slope($d_realized_vol, 23)/($d_realized_vol + 1e-12)",
        "Slope($d_realized_vol, 5)/($d_realized_vol + 1e-12)",
        "Slope($d_trades_close_corr, 23)/($d_trades_close_corr + 1e-12)",
        "Slope($d_trades_close_corr, 61)/($d_trades_close_corr + 1e-12)",
        "Slope($d_trades_vol_corr, 23)/($d_trades_vol_corr + 1e-12)",
        "Slope($d_trades_vol_corr, 61)/($d_trades_vol_corr + 1e-12)",
        "Slope($d_vol, 11)/($d_vol + 1e-12)",
        "Slope($d_vol, 23)/($d_vol + 1e-12)",
        "Slope($d_vol, 5)/($d_vol + 1e-12)",
        "Slope($d_vol_cv, 23)/($d_vol_cv + 1e-12)",
        "Slope($d_vol_cv, 61)/($d_vol_cv + 1e-12)",
        "Slope($d_volatility_of_volume, 61)/($d_volatility_of_volume + 1e-12)",
        "Slope($turn, 11)/($turn + 1e-12)",
        "Slope($turn, 23)/($turn + 1e-12)",
        "Slope($turn, 5)/($turn + 1e-12)",
        "Slope($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 11)/($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)))",
        "Slope($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 23)/($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)))",
        "Slope($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 61)/($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)))",
        "Slope($volume, 11)/($volume + 1e-12)",
        "Slope($volume, 23)/($volume + 1e-12)",
        "Slope($volume, 5)/($volume + 1e-12)",
        "Slope(($buy_volume*2-$volume)/($volume+1e-12), 11)/(($buy_volume*2-$volume)/($volume+1e-12))",
        "Slope(($buy_volume*2-$volume)/($volume+1e-12), 23)/(($buy_volume*2-$volume)/($volume+1e-12))",
        "Slope(($buy_volume*2-$volume)/($volume+1e-12), 5)/(($buy_volume*2-$volume)/($volume+1e-12))",
        "Slope((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 11)/((($buy_amount*2-$amount)*10000)/($market_cap+1e-12))",
        "Slope((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 23)/((($buy_amount*2-$amount)*10000)/($market_cap+1e-12))",
        "Slope((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 5)/((($buy_amount*2-$amount)*10000)/($market_cap+1e-12))",
        "Std($close, 11)/($close + 1e-12)",
        "Std($close, 23)/($close + 1e-12)",
        "Std($d_corr, 23)/($d_corr + 1e-12)",
        "Std($d_hhi, 23)/($d_hhi + 1e-12)",
        "Std($d_hhi, 61)/($d_hhi + 1e-12)",
        "Std($d_intraday_trend, 5)/($d_intraday_trend + 1e-12)",
        "Std($d_realized_vol, 11)/($d_realized_vol + 1e-12)",
        "Std($d_realized_vol, 23)/($d_realized_vol + 1e-12)",
        "Std($d_trades_vol_corr, 23)/($d_trades_vol_corr + 1e-12)",
        "Std($d_trades_vol_corr, 61)/($d_trades_vol_corr + 1e-12)",
        "Std($d_vol, 11)/($d_vol + 1e-12)",
        "Std($d_vol, 23)/($d_vol + 1e-12)",
        "Std($d_vol_cv, 23)/($d_vol_cv + 1e-12)",
        "Std($d_vol_cv, 61)/($d_vol_cv + 1e-12)",
        "Std($d_vwap, 61)/($d_vwap + 1e-12)",
        "Std($turn, 11)/($turn + 1e-12)",
        "Std($turn, 23)/($turn + 1e-12)",
        "Std($turn, 5)/($turn + 1e-12)",
        "Std($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 11)/($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)))",
        "Std($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)), 23)/($volume*10000/($num_trades+1e-12)/($market_cap/($close+1e-12)))",
        "Std($volume, 11)/($volume + 1e-12)",
        "Std($volume, 23)/($volume + 1e-12)",
        "Std($volume, 5)/($volume + 1e-12)",
        "Std(($buy_volume*2-$volume)/($volume+1e-12), 11)/(($buy_volume*2-$volume)/($volume+1e-12))",
        "Std(($buy_volume*2-$volume)/($volume+1e-12), 5)/(($buy_volume*2-$volume)/($volume+1e-12))",
        "Std((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 11)/((($buy_amount*2-$amount)*10000)/($market_cap+1e-12))",
        "Std((($buy_amount*2-$amount)*10000)/($market_cap+1e-12), 5)/((($buy_amount*2-$amount)*10000)/($market_cap+1e-12))",
        "Std(Abs($close/Ref($close, 1)-1)*$volume, 11)/(Mean(Abs($close/Ref($close, 1)-1)*$volume, 11)+1e-12)",
        "Std(Abs($close/Ref($close, 1)-1)*$volume, 23)/(Mean(Abs($close/Ref($close, 1)-1)*$volume, 23)+1e-12)",
        "Std(Abs($close/Ref($close, 1)-1)*$volume, 5)/(Mean(Abs($close/Ref($close, 1)-1)*$volume, 5)+1e-12)",
        "Sum(Greater($close-Ref($close, 1), 0), 11)/(Sum(Abs($close-Ref($close, 1)), 11)+1e-12)",
        "Sum(Greater($close-Ref($close, 1), 0), 5)/(Sum(Abs($close-Ref($close, 1)), 5)+1e-12)",
        "Sum(Greater($volume-Ref($volume, 1), 0), 11)/(Sum(Abs($volume-Ref($volume, 1)), 11)+1e-12)",
        "Sum(Greater($volume-Ref($volume, 1), 0), 5)/(Sum(Abs($volume-Ref($volume, 1)), 5)+1e-12)",
        "Sum(Greater(Ref($close, 1)-$close, 0), 5)/(Sum(Abs($close-Ref($close, 1)), 5)+1e-12)",
        "Sum(Greater(Ref($volume, 1)-$volume, 0), 11)/(Sum(Abs($volume-Ref($volume, 1)), 11)+1e-12)",
        "Sum(Greater(Ref($volume, 1)-$volume, 0), 23)/(Sum(Abs($volume-Ref($volume, 1)), 23)+1e-12)",
        "Sum(Greater(Ref($volume, 1)-$volume, 0), 5)/(Sum(Abs($volume-Ref($volume, 1)), 5)+1e-12)",
        "$i_change_1_std_10",
        "$i_change_1_std_20",
        "$i_change_1_mean_60",
        "Mask($close/Ref($close,1)-1, "sh000001")",
        "Mask(Mean($close/Ref($close,1)-1,5), "sh000001")",
        "Mask(Std($close/Ref($close,1)-1,5), "sh000001")",
        "Mask(Mean($volume,5)/$volume, "sh000001")",
        "Mask(Std($volume,5)/$volume, "sh000001")",
        # "Mask(Mean($close/Ref($close,1)-1,10), "sh000001")",
        # "Mask(Std($close/Ref($close,1)-1,10), "sh000001")",
        # "Mask(Mean($volume,10)/$volume, "sh000001")",
        # "Mask(Std($volume,10)/$volume, "sh000001")",
        "Mask(Mean($close/Ref($close,1)-1,20), "sh000001")",
        "Mask(Std($close/Ref($close,1)-1,20), "sh000001")",
        "Mask(Mean($volume,20)/$volume, "sh000001")",
        "Mask(Std($volume,20)/$volume, "sh000001")",
        # "Mask(Mean($close/Ref($close,1)-1,30), "sh000001")",
        # "Mask(Std($close/Ref($close,1)-1,30), "sh000001")",
        # "Mask(Mean($volume,30)/$volume, "sh000001")",
        # "Mask(Std($volume,30)/$volume, "sh000001")",
        "Mask(Mean($close/Ref($close,1)-1,60), "sh000001")",
        "Mask(Std($close/Ref($close,1)-1,60), "sh000001")",
        "Mask(Mean($volume,60)/$volume, "sh000001")",
        "Mask(Std($volume,60)/$volume, "sh000001")",
        "Mask($close/Ref($close,1)-1, "sh000300")",
        "Mask(Mean($close/Ref($close,1)-1,5), "sh000300")",
        "Mask(Std($close/Ref($close,1)-1,5), "sh000300")",
        "Mask(Mean($volume,5)/$volume, "sh000300")",
        "Mask(Std($volume,5)/$volume, "sh000300")",
        # "Mask(Mean($close/Ref($close,1)-1,10), "sh000300")",
        # "Mask(Std($close/Ref($close,1)-1,10), "sh000300")",
        # "Mask(Mean($volume,10)/$volume, "sh000300")",
        # "Mask(Std($volume,10)/$volume, "sh000300")",
        "Mask(Mean($close/Ref($close,1)-1,20), "sh000300")",
        "Mask(Std($close/Ref($close,1)-1,20), "sh000300")",
        "Mask(Mean($volume,20)/$volume, "sh000300")",
        "Mask(Std($volume,20)/$volume, "sh000300")",
        # "Mask(Mean($close/Ref($close,1)-1,30), "sh000300")",
        # "Mask(Std($close/Ref($close,1)-1,30), "sh000300")",
        # "Mask(Mean($volume,30)/$volume, "sh000300")",
        # "Mask(Std($volume,30)/$volume, "sh000300")",
        "Mask(Mean($close/Ref($close,1)-1,60), "sh000300")",
        "Mask(Std($close/Ref($close,1)-1,60), "sh000300")",
        "Mask(Mean($volume,60)/$volume, "sh000300")",
        "Mask(Std($volume,60)/$volume, "sh000300")",
        "Mask($close/Ref($close,1)-1, "sh000905")",
        "Mask(Mean($close/Ref($close,1)-1,5), "sh000905")",
        "Mask(Std($close/Ref($close,1)-1,5), "sh000905")",
        "Mask(Mean($volume,5)/$volume, "sh000905")",
        "Mask(Std($volume,5)/$volume, "sh000905")",
        # "Mask(Mean($close/Ref($close,1)-1,10), "sh000905")",
        # "Mask(Std($close/Ref($close,1)-1,10), "sh000905")",
        # "Mask(Mean($volume,10)/$volume, "sh000905")",
        # "Mask(Std($volume,10)/$volume, "sh000905")",
        "Mask(Mean($close/Ref($close,1)-1,20), "sh000905")",
        "Mask(Std($close/Ref($close,1)-1,20), "sh000905")",
        "Mask(Mean($volume,20)/$volume, "sh000905")",
        "Mask(Std($volume,20)/$volume, "sh000905")",
        # "Mask(Mean($close/Ref($close,1)-1,30), "sh000905")",
        # "Mask(Std($close/Ref($close,1)-1,30), "sh000905")",
        # "Mask(Mean($volume,30)/$volume, "sh000905")",
        # "Mask(Std($volume,30)/$volume, "sh000905")",
        "Mask(Mean($close/Ref($close,1)-1,60), "sh000905")",
        "Mask(Std($close/Ref($close,1)-1,60), "sh000905")",
        "Mask(Mean($volume,60)/$volume, "sh000905")",
        "Mask(Std($volume,60)/$volume, "sh000905")",
        "Mask($close/Ref($close,1)-1, "sh000906")",
        "Mask(Mean($close/Ref($close,1)-1,5), "sh000906")",
        "Mask(Std($close/Ref($close,1)-1,5), "sh000906")",
        "Mask(Mean($volume,5)/$volume, "sh000906")",
        "Mask(Std($volume,5)/$volume, "sh000906")",
        # "Mask(Mean($close/Ref($close,1)-1,10), "sh000906")",
        # "Mask(Std($close/Ref($close,1)-1,10), "sh000906")",
        # "Mask(Mean($volume,10)/$volume, "sh000906")",
        # "Mask(Std($volume,10)/$volume, "sh000906")",
        "Mask(Mean($close/Ref($close,1)-1,20), "sh000906")",
        "Mask(Std($close/Ref($close,1)-1,20), "sh000906")",
        "Mask(Mean($volume,20)/$volume, "sh000906")",
        "Mask(Std($volume,20)/$volume, "sh000906")",
        # "Mask(Mean($close/Ref($close,1)-1,30), "sh000906")",
        # "Mask(Std($close/Ref($close,1)-1,30), "sh000906")",
        # "Mask(Mean($volume,30)/$volume, "sh000906")",
        # "Mask(Std($volume,30)/$volume, "sh000906")",
        "Mask(Mean($close/Ref($close,1)-1,60), "sh000906")",
        "Mask(Std($close/Ref($close,1)-1,60), "sh000906")",
        "Mask(Mean($volume,60)/$volume, "sh000906")",
        "Mask(Std($volume,60)/$volume, "sh000906")",
        "Ref($adjclose, -5) / Ref($adjclose, -1) - 1",
    ]


    # dl_type = ['test']
    dl_type = ['train', 'valid', 'test']
    for d_type in dl_type:
        dl_data_path_raw = Path(f"{data_path}/{market_name}_self_dl_{d_type}_t.pkl")
        dl_data_path_new = Path(f"{data_path}/{market_name}_self_dl_{d_type}.pkl")

        # if dl_data_path_raw.exists():
        #     dl_data_path_raw.rename(dl_data_path_new)
        

        save_path = dl_data_path_raw
        dl_data = filter_column(dl_data_path_raw, dl_data_path_new, need_cols)
        # print(dl_data.data)



if __name__ == "__main__":
    fire.Fire(main)
    


    

