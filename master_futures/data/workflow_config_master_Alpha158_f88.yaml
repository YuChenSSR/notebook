qlib_init:
  provider_uri: "/home/idc2/notebook/futures/data/qlib_bin/cn_data_train"
  region: cn

# 只跑主力连续（*88），依赖 qlib_bin/instruments/f88.txt 已生成
market: &market f88

# 期货训练暂不依赖 benchmark（训练入口会兼容缺失）；保留字段便于后续扩展
benchmark: &benchmark null

# 回测参数（用于一键脚本的 Qlib 仿真回测；不参与训练）
# 注意：benchmark 不能缺省，否则 Qlib 会回退到 CSI300 基准并在期货数据上报错。
# 这里将 benchmark 置为 null，由回测脚本根据 instruments/f88.txt 自动构造“等权基准”（或用命令行显式指定）。
port_analysis_config: &port_analysis_config
  strategy:
    class: TopkDropoutStrategy
    module_path: qlib.contrib.strategy
    kwargs:
      signal: <PRED>
      topk: 30
      n_drop: 3
      only_tradable: false
      forbid_all_trade_at_limit: false
  backtest:
    start_time: 2025-01-01
    end_time: 2025-12-12
    freq: day
    account: 100000000
    benchmark: null
    exchange_kwargs:
      deal_price: close
      limit_threshold: 0.095
      open_cost: 0.0015
      close_cost: 0.0015
      min_cost: 5

data_handler_config: &data_handler_config
  start_time: 2010-01-04
  end_time: 2025-12-12
  fit_start_time: 2010-01-04
  fit_end_time: 2024-06-30
  instruments: *market
  infer_processors:
    - class: RobustZScoreNorm
      kwargs:
        fields_group: feature
        clip_outlier: true
    - class: Fillna
      kwargs:
        fields_group: feature
  learn_processors:
    - class: DropnaLabel
      kwargs:
        fields_group: label
  label: ["Ref($adjclose, -5) / Ref($adjclose, -1) - 1"]

task:
  model:
    class: MASTERModel
    module_path: master_futures.code.Master.master
    kwargs:
      seed: 0
      seed_num: 5

      # FuturesAlpha158 base_features=163（见 handler_futures_alpha158.py），额外追加 gate_features=8
      d_feat: 162
      gate_input_start_index: 162
      gate_input_end_index: 163

      d_model: 256
      t_nhead: 4
      s_nhead: 2
      dropout: 0.2

      n_epochs: 20
      lr: 0.00001
      # 学习率调度器（可选；不配置则固定 lr）
      # lr_scheduler: cosine          # 可选: none | cosine | step | plateau
      # lr_scheduler_kwargs:
      #   T_max: 20                   # cosine: 1 个周期长度（通常 = n_epochs）
      #   eta_min: 1.0e-6             # cosine: 最小 lr
      # lr_scheduler_monitor: train_loss   # plateau 时使用：train_loss / valid_IC / valid_ICIR / valid_RIC / valid_RICIR
      train_stop_loss_thred: 0.2
      GPU: 0
      beta: 2

      market: *market
      benchmark: *benchmark
      save_prefix: *market

  dataset:
    class: TSDatasetH
    module_path: qlib.data.dataset
    kwargs:
      handler:
        class: FuturesAlpha158WithGate
        module_path: master_futures.code.handler_futures_alpha158
        kwargs: *data_handler_config
      segments:
        train: [2010-01-04, 2024-06-30]
        valid: [2024-07-01, 2024-12-31]
        test: [2025-01-01, 2025-12-12]
      step_len: 8

