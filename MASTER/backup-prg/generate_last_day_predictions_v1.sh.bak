#!/bin/bash
set -e

# 进入MASTER目录
cd ~/notebook/MASTER

# 获取当天日期
today=$(date +%Y-%m-%d)
echo $today

# 人工指定日期
# today="2025-04-02"
# echo ${today}

# 获取当前是星期几（1-7，1=周一，7=周日）
current_day=$(date +%u)
echo current day is $current_day

# 如果是周六（6）或周日（7），则退出脚本
if [ "$current_day" -eq 6 ] || [ "$current_day" -eq 7 ]; then
    echo "Today is weekend. Exiting..."
    exit 0
fi

# 若预测结果已存在，终止执行；若不存在，说明上次执行失败，再次执行
if [ -f ~/notebook/MASTER/master_predictions_csi300_2_single_day_${today}.csv ]; then
    echo "已完成预测，无需再次执行"
    exit 0
else
    echo "未找到预测结果，再次执行"
fi

# 动态生成 URL
url="https://github.com/chenditc/investment_data/releases/download/${today}/qlib_bin.tar.gz"

# 删除上次压缩包
if [ -f ~/notebook/qlib_bin.tar.gz ]; then
    rm ~/notebook/qlib_bin.tar.gz
    echo "旧文件存在，已删除"
else
    echo "旧文件不存在，无需删除"
fi

# 下载文件到指定目录
wget -P ~/notebook "$url"

echo "文件已下载到 ~/notebook"

tar -xzvf ~/notebook/qlib_bin.tar.gz -C ~/notebook

echo "qlib_bin.tar.gz 已完成解压"

# 替换 YAML 文件中的当天日期占位符
sed -i s/{{today}}/$today/g workflow_config_master_Alpha158_4_last_day_predictions.yaml

# 执行数据划分
python3 data_generator_4_last_day_predictions.py 

echo "完成数据划分"

# 执行预测
python3 predict_and_send_result.py

echo "完成预测"

# 还原 YAML 文件中的当天日期占位符
sed -i s/$today/{{today}}/g workflow_config_master_Alpha158_4_last_day_predictions.yaml

echo "YAML文件还原完成"

# 删除每天整合的数据文件（每天大于2GB，占用存储空间，每次执行后删除比较稳妥）
today=$(date +%Y%m%d)

# 人工指定日期
# today="20250327"

rm handler_20080101_${today}.pkl

echo "临时数据已删除"